# Gazebo: 물리 엔진 기반 다개체 시뮬레이션

**Gazebo**는 로봇 공학 연구 및 개발에 널리 사용되는 강력한 3D 물리 시뮬레이터입니다. 실제 로봇을 제작하거나 사용하기 전에, 가상의 환경에서 로봇의 동작, 센서 데이터, 제어 알고리즘 등을 테스트할 수 있게 해줍니다. ROS와 완벽하게 통합되어 있어, 시뮬레이션 환경과 ROS 2 노드를 쉽게 연동할 수 있습니다.

## 1. Gazebo의 주요 특징

- **물리 엔진:** ODE, Bullet, DART, Simbody 등 다양한 고성능 물리 엔진을 지원하여 중력, 마찰, 충돌 등 현실적인 물리 현상을 시뮬레이션합니다. 이를 통해 로봇이 실제 환경에서 어떻게 동작할지를 예측할 수 있습니다.
- **다양한 센서 시뮬레이션:**
  - 카메라 (단안, 스테레오, 뎁스)
  - 라이다 (2D, 3D)
  - IMU (관성 측정 장치)
  - GPS
  - 접촉 센서, 힘/토크 센서 등
  이러한 가상 센서들은 ROS 토픽을 통해 실제 센서와 거의 동일한 형태의 데이터를 발행하므로, 센서 데이터를 처리하는 알고리즘을 실제 로봇 없이도 개발하고 테스트할 수 있습니다.
- **다개체 시뮬레이션 (Multi-Robot Simulation):** 여러 대의 로봇을 하나의 시뮬레이션 월드에 동시에 생성하고 상호작용을 시뮬레이션할 수 있습니다. 군집 로봇 알고리즘 개발에 필수적입니다.
- **ROS 통합:** `ros_gz_bridge` 패키지를 통해 Gazebo의 Transport Layer(Gz Transport)와 ROS 2의 통신 시스템을 연결합니다. 이를 통해 ROS 2 노드가 Gazebo의 시뮬레이션 데이터를 구독하거나, Gazebo 내의 로봇을 제어하는 명령을 발행할 수 있습니다.
- **플러그인 시스템:** 사용자가 C++로 직접 플러그인을 작성하여 Gazebo의 기능을 확장할 수 있습니다. (예: 새로운 센서 모델, 액추에이터 제어 방식, 외부 환경 효과 등)

## 2. Gazebo의 구성 요소

### 2.1. 월드 (World)
**월드(`.world` 파일)**는 시뮬레이션이 일어나는 전체 환경을 정의합니다. 월드 파일에는 다음과 같은 정보가 포함됩니다.
- **장면(Scene):** 조명, 배경색, 그림자 등 시각적 환경 설정
- **물리(Physics):** 사용할 물리 엔진, 중력, 시간 스텝(time step) 등 물리적 속성 설정
- **모델(Models):** 월드에 배치될 모든 정적/동적 객체(로봇, 건물, 장애물 등)의 종류와 초기 위치

### 2.2. 모델 (Model)
**모델**은 로봇, 가구, 건물 등 시뮬레이션에 등장하는 개별적인 객체를 의미합니다. 모델은 **SDF(Simulation Description Format)**라는 XML 기반 형식으로 기술됩니다.
- **SDF vs. URDF:** URDF가 로봇의 운동학적 구조(링크와 조인트)를 기술하는 데 중점을 둔다면, SDF는 Gazebo 시뮬레이션에 필요한 모든 정보(물리 속성, 센서, 플러그인 등)를 포함하는 더 포괄적인 형식입니다. ROS에서는 URDF를 SDF로 자동 변환하여 Gazebo에서 사용하는 경우가 많습니다.
- **Gazebo Fuel:** 다른 사용자들이 만들어서 공유하는 다양한 로봇 및 환경 모델을 다운로드할 수 있는 온라인 라이브러리입니다.

## 3. ROS 2와 Gazebo 연동

ROS 2와 Gazebo를 연동하는 과정은 보통 다음과 같습니다.

1.  **로봇 모델 준비 (URDF/SDF):** 시뮬레이션할 로봇의 URDF 또는 SDF 파일을 준비합니다. URDF에는 Gazebo에서만 사용하는 태그(`<gazebo>`)를 추가하여 시뮬레이션 관련 정보(플러그인, 물리 속성 등)를 포함시킬 수 있습니다.

2.  **Gazebo 플러그인 설정:** 로봇 모델(SDF) 파일 안에 ROS와 연동하기 위한 플러그인을 설정합니다.
    - **`libgz-sim-diff-drive-system`:** 차동 구동 방식(바퀴 2개) 로봇의 움직임을 제어하는 플러그인. `/cmd_vel` 토픽을 구독하여 로봇을 움직이고, `/odom` 토픽을 발행합니다.
    - **`libgz-sim-sensors-system`:** 카메라, 라이다 등 센서 플러그인을 로드하고, 센서 데이터를 ROS 2 토픽으로 발행하는 역할을 합니다.

3.  **브릿지 설정 (`ros_gz_bridge`):** Gazebo의 토픽과 ROS 2의 토픽을 연결하는 브릿지를 설정합니다. 예를 들어, Gazebo의 `/lidar` 토픽을 ROS 2의 `/scan` 토픽으로 변환하여 ROS 2 노드들이 사용할 수 있게 합니다. 이 설정은 launch 파일에서 주로 이루어집니다.

4.  **Launch 파일 작성:**
    - Gazebo 시뮬레이션 서버(`gz sim`)와 GUI 클라이언트(`gz client`)를 실행합니다.
    - `ros2 run gazebo_ros spawn_entity.py`를 사용하여 로봇 모델을 시뮬레이션 월드에 생성(spawn)합니다.
    - `robot_state_publisher` 노드를 실행하여 로봇의 상태를 TF로 발행합니다.
    - `ros_gz_bridge`를 설정하여 필요한 토픽들을 연결합니다.

**예시 Launch 파일의 일부:**
```python
# Gazebo 실행
gazebo = IncludeLaunchDescription(
    PythonLaunchDescriptionSource(
        os.path.join(get_package_share_directory('ros_gz_sim'), 'launch', 'gz_sim.launch.py')
    ),
    launch_arguments={'gz_args': '-r empty.sdf'}.items(),
)

# 로봇 스폰
spawn_entity = Node(
    package='ros_gz_sim',
    executable='create',
    arguments=['-topic', 'robot_description', '-entity', 'my_robot'],
    output='screen',
)

# 브릿지 설정
bridge = Node(
    package='ros_gz_bridge',
    executable='parameter_bridge',
    arguments=['/scan@sensor_msgs/msg/LaserScan@/lidar'],
    output='screen',
)
```

Gazebo는 실제 하드웨어의 위험 부담과 비용 없이 로봇 소프트웨어를 안전하고 반복적으로 테스트할 수 있는 매우 효율적인 개발 환경을 제공합니다. 복잡한 시나리오를 가상으로 구현하고, 다양한 조건에서 알고리즘의 강건성(robustness)을 검증하는 데 필수적인 도구입니다.
