# TF (Transform Library): 로봇의 동적인 좌표 변환 관리

로봇 시스템은 카메라, 라이다, 바퀴, 로봇 팔 등 수많은 센서와 액추에이터로 구성됩니다. 이러한 각 부품은 자신만의 **좌표계(Coordinate Frame)**를 가지고 있습니다. 예를 들어, 카메라 센서는 이미지 데이터를 '카메라 좌표계' 기준으로 생성하고, 라이다 센서는 '라이다 좌표계' 기준으로 거리 데이터를 측정합니다. 로봇이 의미 있는 작업을 수행하려면, 이처럼 흩어져 있는 여러 좌표계의 데이터를 하나의 공통된 기준 좌표계(예: 로봇의 중심 `base_link`)로 통합해야 합니다.

**TF(Transform Library)**는 이처럼 복잡하고 동적으로 변화하는 로봇의 여러 좌표계 간의 관계를 관리하고 계산해주는 ROS의 핵심 라이브러리입니다. ROS 2에서는 **TF2**가 표준으로 사용됩니다.

## 1. 왜 TF가 필요한가?

예를 들어, 로봇에 부착된 카메라가 1미터 앞에 공을 발견했다고 가정해 봅시다.
- 카메라는 "내(`camera_link`) 앞에서 1미터"라고 인식합니다.
- 로봇의 팔(`gripper_link`)이 이 공을 잡으려면, "내(`gripper_link`) 기준으로 공이 어디에 있는지" 알아야 합니다.
- 이를 위해서는 `camera_link`와 `gripper_link` 사이의 수학적인 관계(위치와 방향)를 알아야 변환이 가능합니다.

만약 로봇의 목이 움직여 카메라의 방향이 바뀌거나, 팔을 뻗어 그리퍼의 위치가 바뀐다면 이 관계는 계속해서 변하게 됩니다. TF는 이러한 **동적인 좌표 변환(Dynamic Transform)** 정보를 실시간으로 추적하고 관리해주는 역할을 합니다.

## 2. TF의 핵심 개념

### 2.1. 프레임 (Frame)
**프레임(Frame)**은 좌표계를 의미합니다. ROS에서는 각 프레임에 고유한 이름(frame_id)을 부여하여 관리합니다. 관례적으로 `_link` 접미사를 붙입니다.
- `base_link`: 로봇의 기준이 되는 몸체 중심 프레임
- `camera_link`: 카메라 센서의 광학 중심 프레임
- `laser_frame`: 라이다 센서의 중심 프레임
- `wheel_left_link`: 왼쪽 바퀴의 중심 프레임

### 2.2. 변환 (Transform)
**변환(Transform)**은 한 프레임에서 다른 프레임으로 이동하기 위한 **위치(Translation)**와 **회전(Rotation)** 정보입니다. TF 라이브러리는 이 변환 정보를 `geometry_msgs/msg/TransformStamped` 메시지 형태로 주고받습니다.

### 2.3. TF 트리 (TF Tree)
TF는 모든 프레임 간의 관계를 **트리(Tree)** 구조로 관리합니다.
- **부모-자식 관계:** 모든 변환 정보는 '부모 프레임'과 '자식 프레임' 사이의 관계로 정의됩니다. 예를 들어, `base_link`(부모)에 카메라가 달려있다면 `camera_link`(자식)가 됩니다.
- **연결성:** 트리의 모든 프레임은 끊어짐 없이 하나로 연결되어 있어야 합니다.
- **시간 정보:** 모든 TF 변환 정보에는 타임스탬프(timestamp)가 포함되어 있어, 특정 시점의 좌표계 관계를 정확히 계산할 수 있습니다.

![TF Tree Example](https-i-imgur-com-abcdef-png)
*(실제 이미지 대신 설명을 위한 예시입니다. odom -> base_link -> camera_link 와 같은 TF 트리를 시각적으로 표현)*

위 그림에서 `base_link`는 `odom` 프레임의 자식이자 `camera_link`의 부모입니다. TF 라이브러리는 `odom`에서 `camera_link`로의 변환을 요청받으면, `odom` -> `base_link` 변환과 `base_link` -> `camera_link` 변환을 연쇄적으로 계산하여 최종 결과를 알려줍니다.

## 3. TF 사용 방법

### 3.1. TF 발행 (Broadcasting Transforms)
로봇의 각 관절 상태나 위치 추정 결과를 바탕으로 TF 변환 정보를 발행해야 합니다.
- **Static Transform Publisher:** 로봇에 고정되어 움직이지 않는 프레임 간의 관계(예: `base_link`와 `camera_link`의 고정된 위치)를 발행할 때 사용합니다. 주로 launch 파일에서 설정합니다.
- **Transform Broadcaster (코드 내에서):** 로봇의 관절 각도처럼 실시간으로 변하는 프레임 간의 관계를 코드 내에서 계산하여 발행합니다. `robot_state_publisher` 노드가 대표적인 예로, 로봇의 URDF 모델과 관절 상태(`joint_states` 토픽)를 바탕으로 모든 링크 간의 TF를 발행해줍니다.

### 3.2. TF 수신 및 사용 (Listening for Transforms)
- **TF Listener:** 코드 내에서 TF 라이브러리의 `TransformListener`와 `Buffer`를 사용하여 특정 프레임 간의 변환 정보를 질의(query)할 수 있습니다.
  ```python
  # camera_link 좌표계의 한 점(point_in_camera)을 base_link 좌표계로 변환
  try:
      transform = tf_buffer.lookup_transform('base_link', 'camera_link', rclpy.time.Time())
      point_in_base = tf2_geometry_msgs.do_transform_point(point_in_camera, transform)
  except (tf2_ros.LookupException, tf2_ros.ConnectivityException, tf2_ros.ExtrapolationException) as e:
      self.get_logger().error(f'Could not transform camera_link to base_link: {e}')
  ```

## 4. TF 디버깅 도구

- **`tf2_tools` 패키지:**
  - **`ros2 run tf2_ros tf2_echo <source_frame> <target_frame>`**: 두 프레임 간의 변환 관계를 실시간으로 터미널에 출력합니다.
    ```bash
    ros2 run tf2_ros tf2_echo base_link camera_link
    ```
  - **`ros2 run tf2_tools view_frames`**: 현재 TF 트리를 PDF 파일로 생성하여 시각적으로 보여줍니다.
    ```bash
    ros2 run tf2_tools view_frames
    # frames.pdf 파일이 생성됨
    ```
- **Rviz2:**
  - 'TF' 디스플레이 플러그인을 추가하면 모든 프레임과 그 관계를 3D 공간상에 시각적으로 표시해주어 디버깅에 매우 유용합니다.

TF는 ROS 기반의 로봇 시스템에서 인식, 내비게이션, 매니퓰레이션 등 거의 모든 기능의 기반이 되는 핵심적인 개념입니다. 여러 좌표계의 데이터를 통합하고 로봇의 움직임을 이해하기 위해서는 TF에 대한 정확한 이해가 필수적입니다.
